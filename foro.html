<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="description" content="Foro de la comunidad AngulismoTV">
<meta name="theme-color" content="#0b0d1b">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Foro - AngulismoTV</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="shortcut icon" href="assets/logo.png" type="image/x-icon">

<!-- CSS Espacial - mismo que tu index -->
<link rel="stylesheet" href="css/espacial-base.css">
<link rel="stylesheet" href="css/header-unificado.css">

<style>
/* ===== FORO SIN CONFLICTOS CON CSS ESPACIAL ===== */

/* Contenedor principal - usa variables del CSS espacial */
.foro-container {
    max-width: 800px;
    margin: 20px auto;
    padding: 0 15px;
    min-height: calc(100vh - 200px);
    position: relative;
    z-index: 2;
}

.foro-header {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px 0;
    position: relative;
    z-index: 2;
}

.foro-title {
    font-size: 2.5rem;
    background: linear-gradient(135deg, #72d6ff, #ff7fff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 10px;
    font-weight: 700;
}

.foro-subtitle {
    color: rgba(255, 255, 255, 0.7);
    font-size: 1.1rem;
}

/* √Årea de mensajes - compatible con tema espacial */
.mensajes-container {
    background: rgba(11, 13, 27, 0.6);
    border-radius: 15px;
    border: 1px solid rgba(114, 214, 255, 0.2);
    padding: 20px;
    margin-bottom: 20px;
    min-height: 400px;
    max-height: 60vh;
    overflow-y: auto;
    position: relative;
    z-index: 2;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.mensaje-item {
    background: rgba(255, 255, 255, 0.05);
    padding: 15px;
    margin: 10px 0;
    border-radius: 10px;
    border-left: 3px solid #72d6ff;
    transition: all 0.3s ease;
}

.mensaje-item:hover {
    background: rgba(255, 255, 255, 0.08);
    transform: translateY(-1px);
}

.mensaje-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.mensaje-nombre {
    color: #72d6ff;
    font-weight: 600;
    font-size: 1em;
}

.mensaje-fecha {
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.8em;
}

.mensaje-texto {
    color: rgba(255, 255, 255, 0.9);
    line-height: 1.5;
    word-wrap: break-word;
}

/* FORMULARIO INTEGRADO - NO FIJO */
.formulario-integrado {
    background: rgba(11, 13, 27, 0.8);
    border-radius: 15px;
    border: 1px solid rgba(114, 214, 255, 0.2);
    padding: 20px;
    margin: 30px 0;
    position: relative;
    z-index: 2;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.form-container {
    display: grid;
    grid-template-columns: 1fr 2fr auto;
    gap: 12px;
    align-items: end;
}

.form-header {
    color: #72d6ff;
    font-weight: 600;
    margin-bottom: 15px;
    font-size: 1.1em;
    display: flex;
    align-items: center;
    gap: 8px;
}

.form-header::before {
    content: '‚úçÔ∏è';
    font-size: 1.2em;
}

.foro-input, .foro-textarea {
    width: 100%;
    padding: 12px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    color: white;
    font-family: 'Inter', sans-serif;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.foro-input:focus, .foro-textarea:focus {
    outline: none;
    border-color: #72d6ff;
    background: rgba(255, 255, 255, 0.15);
    box-shadow: 0 0 0 2px rgba(114, 214, 255, 0.2);
}

.foro-input::placeholder, .foro-textarea::placeholder {
    color: rgba(255, 255, 255, 0.6);
}

.foro-textarea {
    resize: vertical;
    min-height: 60px;
    max-height: 120px;
}

.btn-foro {
    background: linear-gradient(135deg, #72d6ff, #ff7fff);
    color: #0b0d1b;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
    white-space: nowrap;
    height: fit-content;
    transition: all 0.3s ease;
    min-height: 44px;
}

.btn-foro:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(114, 214, 255, 0.4);
}

.btn-foro:active {
    transform: translateY(0);
}

/* Estados */
.loading, .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: rgba(255, 255, 255, 0.7);
}

.empty-state::before {
    content: 'üí¨';
    font-size: 2em;
    display: block;
    margin-bottom: 10px;
    opacity: 0.7;
}

/* Scrollbar personalizado que respeta el tema espacial */
.mensajes-container::-webkit-scrollbar {
    width: 8px;
}

.mensajes-container::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
}

.mensajes-container::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #72d6ff, #ff7fff);
    border-radius: 4px;
}

.mensajes-container::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #8adfff, #ff99ff);
}

/* ===== CONTROLES DE M√öSICA ===== */
.music-controls {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(11, 13, 27, 0.8);
    backdrop-filter: blur(10px);
    border-radius: 30px;
    padding: 8px 15px;
    border: 1px solid rgba(114, 214, 255, 0.3);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
}

.music-controls:hover {
    background: rgba(11, 13, 27, 0.9);
    border-color: rgba(114, 214, 255, 0.6);
}

.music-toggle {
    background: none;
    border: none;
    color: #72d6ff;
    cursor: pointer;
    font-size: 18px;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.music-toggle:hover {
    background: rgba(114, 214, 255, 0.1);
    transform: scale(1.1);
}

.volume-control {
    width: 80px;
    height: 4px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 2px;
    position: relative;
    cursor: pointer;
}

.volume-slider {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: #72d6ff;
    border-radius: 2px;
    width: 70%;
}

.volume-handle {
    position: absolute;
    top: 50%;
    right: 0;
    width: 12px;
    height: 12px;
    background: #72d6ff;
    border-radius: 50%;
    transform: translate(50%, -50%);
    box-shadow: 0 0 5px rgba(114, 214, 255, 0.8);
    cursor: grab;
}

.volume-handle:active {
    cursor: grabbing;
}

.music-info {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.7);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 120px;
}

/* ===== RESPONSIVE M√ìVIL ===== */
@media (max-width: 768px) {
    .foro-container {
        margin: 10px auto;
        padding: 0 10px;
    }
    
    .foro-title {
        font-size: 2rem;
    }
    
    .mensajes-container {
        padding: 15px;
        max-height: 50vh;
        margin-bottom: 15px;
    }
    
    .formulario-integrado {
        padding: 15px;
        margin: 20px 0;
    }
    
    .form-container {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .btn-foro {
        padding: 14px 20px;
        width: 100%;
    }
    
    .mensaje-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
    }
    
    .mensaje-fecha {
        font-size: 0.75em;
    }
    
    /* M√∫sica responsive */
    .music-controls {
        bottom: 10px;
        right: 10px;
        padding: 6px 12px;
    }
    
    .music-info {
        max-width: 80px;
        font-size: 10px;
    }
    
    .volume-control {
        width: 60px;
    }
}

/* ===== PC ===== */
@media (min-width: 769px) {
    .mensajes-container {
        max-height: 65vh;
    }
}

/* Asegurar que el contenido est√© sobre el fondo espacial */
.foro-container,
.mensajes-container,
.formulario-integrado {
    position: relative;
    z-index: 2;
}

/* Prevenir interferencias con elementos espaciales */
#starfield,
.spiral-galaxy,
.aurora,
.star,
.shooting-star,
.comet,
.planet {
    pointer-events: none;
}

/* Mejorar el footer existente */
.site-footer {
    margin-top: 40px !important;
    position: relative;
    z-index: 2;
}
</style>

<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-P2V7GWXLHJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-P2V7GWXLHJ');
</script>
</head>

<body>
<div id="starfield">
  <div class="spiral-galaxy"></div>
  <div class="aurora aurora-1"></div>
  <div class="aurora aurora-2"></div>
</div>

<!-- Controles de m√∫sica -->
<div class="music-controls">
    <div class="music-info">M√∫sica de fondo</div>
    <div class="volume-control" id="volumeControl">
        <div class="volume-slider" id="volumeSlider"></div>
        <div class="volume-handle" id="volumeHandle"></div>
    </div>
    <button class="music-toggle" id="musicToggle" aria-label="Reproducir/Pausar m√∫sica">
        <span id="musicIcon">‚ñ∂</span>
    </button>
</div>

<!-- HEADER UNIFICADO -->
<header class="site-header">
  <div class="logo-container">
    <a href="index.html" aria-label="AngulismoTV - Inicio">
      <img src="assets/logo2.png" alt="AngulismoTV" class="logo">
    </a>
  </div>
  
  <nav role="navigation" aria-label="Navegaci√≥n principal">
    <a href="index.html#channelsSection">Canales</a>
    <a href="index.html#agendaFrame">Agenda</a>
    <a href="multicam.html">Pantalla Dividida</a>
    <a href="https://nowevents.xyz">Entretenimiento</a>
    <a href="https://nowstats.netlify.app">Estad√≠sticas</a>
    <a href="foro.html">Foro</a>
  </nav>
</header>

<main class="foro-container">
    <div class="foro-header">
        <h1 class="foro-title">üí¨ Foro de la Comunidad</h1>
        <p class="foro-subtitle">No me saturen los servers gorditos</p>
    </div>

    <!-- √Årea de mensajes -->
    <div id="listaMensajes" class="mensajes-container">
        <div class="loading">Cargando mensajes...</div>
    </div>

    <!-- FORMULARIO INTEGRADO EN EL FLUJO NORMAL -->
    <div class="formulario-integrado">
        <div class="form-header">Escrib√≠ tu mensaje</div>
        <div class="form-container">
            <input type="text" id="foroNombre" placeholder="Tu nombre" maxlength="30" class="foro-input">
            <textarea id="foroMensaje" placeholder="¬øQu√© quer√©s compartir con la comunidad?" rows="3" maxlength="500" class="foro-textarea"></textarea>
            <button onclick="enviarMensaje()" class="btn-foro">Enviar</button>
        </div>
    </div>
</main>

<footer class="site-footer">
  <div class="container">
    <small>¬© 2025 AngulismoTV | <a href="dmca.html">DMCA</a></small>
    <small>
      <a href="https://x.com/AngulismoTV">Twitter</a> | 
      <a href="https://discord.gg/jEayDA7T">Discord</a>
    </small>
  </div>
</footer>

<!-- Elemento de audio para la m√∫sica de fondo -->
<audio id="backgroundMusic" loop>
    <!-- Reemplaza esta URL con la de tu archivo de m√∫sica -->
    <source src="music/background-music.mp3" type="audio/mpeg">
    <source src="music/background-music.ogg" type="audio/ogg">
    Tu navegador no soporta el elemento de audio.
</audio>

<script>
// URL de tu Worker del foro
const FORO_API_URL = 'https://foro.angulismotv.workers.dev';

// ==================== Control de M√∫sica de Fondo ====================
const backgroundMusic = document.getElementById('backgroundMusic');
const musicToggle = document.getElementById('musicToggle');
const musicIcon = document.getElementById('musicIcon');
const volumeControl = document.getElementById('volumeControl');
const volumeSlider = document.getElementById('volumeSlider');
const volumeHandle = document.getElementById('volumeHandle');

// Estado inicial de la m√∫sica
let isMusicPlaying = false;
let volume = 0.7; // Volumen por defecto (70%)

// Cargar configuraci√≥n guardada
function loadMusicSettings() {
    const savedVolume = localStorage.getItem('angulismotv_music_volume');
    const savedState = localStorage.getItem('angulismotv_music_state');
    
    if (savedVolume !== null) {
        volume = parseFloat(savedVolume);
        updateVolumeUI();
    }
    
    if (savedState === 'playing') {
        playMusic();
    }
}

// Guardar configuraci√≥n
function saveMusicSettings() {
    localStorage.setItem('angulismotv_music_volume', volume);
    localStorage.setItem('angulismotv_music_state', isMusicPlaying ? 'playing' : 'paused');
}

// Actualizar interfaz de volumen
function updateVolumeUI() {
    volumeSlider.style.width = (volume * 100) + '%';
    volumeHandle.style.right = ((1 - volume) * 100) + '%';
    backgroundMusic.volume = volume;
}

// Reproducir m√∫sica
function playMusic() {
    backgroundMusic.play().then(() => {
        isMusicPlaying = true;
        musicIcon.textContent = '‚è∏';
        saveMusicSettings();
    }).catch(error => {
        console.log('Error al reproducir m√∫sica:', error);
        // En algunos navegadores, la reproducci√≥n autom√°tica est√° bloqueada
        // El usuario tendr√° que interactuar manualmente
    });
}

// Pausar m√∫sica
function pauseMusic() {
    backgroundMusic.pause();
    isMusicPlaying = false;
    musicIcon.textContent = '‚ñ∂';
    saveMusicSettings();
}

// Alternar reproducci√≥n/pausa
function toggleMusic() {
    if (isMusicPlaying) {
        pauseMusic();
    } else {
        playMusic();
    }
}

// Configurar controles de volumen
function setupVolumeControls() {
    let isDragging = false;
    
    // Actualizar volumen al hacer clic en la barra
    volumeControl.addEventListener('click', (e) => {
        const rect = volumeControl.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        volume = Math.max(0, Math.min(1, clickX / rect.width));
        updateVolumeUI();
        saveMusicSettings();
    });
    
    // Arrastrar el controlador de volumen
    volumeHandle.addEventListener('mousedown', (e) => {
        isDragging = true;
        e.preventDefault();
    });
    
    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        
        const rect = volumeControl.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        volume = Math.max(0, Math.min(1, clickX / rect.width));
        updateVolumeUI();
    });
    
    document.addEventListener('mouseup', () => {
        if (isDragging) {
            isDragging = false;
            saveMusicSettings();
        }
    });
    
    // Soporte t√°ctil para m√≥viles
    volumeHandle.addEventListener('touchstart', (e) => {
        isDragging = true;
        e.preventDefault();
    });
    
    document.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        
        const rect = volumeControl.getBoundingClientRect();
        const touchX = e.touches[0].clientX - rect.left;
        volume = Math.max(0, Math.min(1, touchX / rect.width));
        updateVolumeUI();
    });
    
    document.addEventListener('touchend', () => {
        if (isDragging) {
            isDragging = false;
            saveMusicSettings();
        }
    });
}

// Inicializar controles de m√∫sica
function initMusicControls() {
    musicToggle.addEventListener('click', toggleMusic);
    setupVolumeControls();
    loadMusicSettings();
    updateVolumeUI();
    
    // En m√≥viles, empezar con la m√∫sica pausada para ahorrar bater√≠a
    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        pauseMusic();
    }
}

// ==================== Funciones del Foro ====================

// Cargar mensajes cuando la p√°gina se carga
document.addEventListener('DOMContentLoaded', function() {
    cargarMensajes();
    initMusicControls(); // Inicializar controles de m√∫sica
    
    // Enviar con Enter
    document.getElementById('foroMensaje').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            enviarMensaje();
        }
    });
    
    // Auto-focus en el mensaje
    document.getElementById('foroMensaje').focus();
});

// Funci√≥n para cargar mensajes
async function cargarMensajes() {
    try {
        const response = await fetch(FORO_API_URL + '/mensajes');
        
        if (!response.ok) {
            throw new Error('Error en la respuesta: ' + response.status);
        }
        
        const mensajes = await response.json();
        const lista = document.getElementById('listaMensajes');
        
        if (!mensajes || mensajes.length === 0) {
            lista.innerHTML = '<div class="empty-state">No hay mensajes todav√≠a.<br>¬°S√© el primero en publicar!</div>';
            return;
        }
        
        // Ordenar: m√°s antiguos arriba, m√°s recientes abajo
        const mensajesOrdenados = [...mensajes].sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
        
        // Crear HTML de los mensajes
        lista.innerHTML = mensajesOrdenados.map(msg => `
            <div class="mensaje-item">
                <div class="mensaje-header">
                    <span class="mensaje-nombre">${msg.nombre}</span>
                    <span class="mensaje-fecha">${formatFecha(msg.fecha)}</span>
                </div>
                <div class="mensaje-texto">${msg.mensaje}</div>
            </div>
        `).join('');
        
        // Scroll al final
        setTimeout(() => {
            lista.scrollTop = lista.scrollHeight;
        }, 100);
        
    } catch (error) {
        console.error('Error cargando mensajes:', error);
        lista.innerHTML = '<div class="empty-state">Error al cargar los mensajes.<br>Intenta recargar la p√°gina.</div>';
    }
}

// Funci√≥n para formatear fecha
function formatFecha(fechaString) {
    const fecha = new Date(fechaString);
    const ahora = new Date();
    
    if (fecha.toDateString() === ahora.toDateString()) {
        return `Hoy ${fecha.toLocaleTimeString('es-ES', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: false 
        })}`;
    }
    
    const ayer = new Date(ahora);
    ayer.setDate(ahora.getDate() - 1);
    if (fecha.toDateString() === ayer.toDateString()) {
        return `Ayer ${fecha.toLocaleTimeString('es-ES', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: false 
        })}`;
    }
    
    return fecha.toLocaleDateString('es-ES', {
        day: 'numeric',
        month: 'short',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    });
}

// Funci√≥n para enviar mensaje
async function enviarMensaje() {
    const nombre = document.getElementById('foroNombre').value.trim();
    const mensaje = document.getElementById('foroMensaje').value.trim();
    
    if (!nombre) {
        alert('Por favor, ingres√° tu nombre');
        document.getElementById('foroNombre').focus();
        return;
    }
    
    if (!mensaje) {
        alert('Por favor, escrib√≠ un mensaje');
        document.getElementById('foroMensaje').focus();
        return;
    }
    
    try {
        const response = await fetch(FORO_API_URL + '/mensajes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                nombre: nombre,
                mensaje: mensaje
            })
        });
        
        const resultado = await response.json();
        
        if (response.ok && resultado.success) {
            document.getElementById('foroMensaje').value = '';
            document.getElementById('foroMensaje').focus();
            await cargarMensajes();
            
            // Scroll suave al formulario despu√©s de enviar
            setTimeout(() => {
                document.querySelector('.formulario-integrado').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'center'
                });
            }, 300);
            
        } else {
            alert('Error al publicar el mensaje');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error de conexi√≥n');
    }
}

// Recargar mensajes cada 20 segundos
setInterval(cargarMensajes, 20000);
</script>

<script defer src="scripts/main.js"></script>
</body>
</html>