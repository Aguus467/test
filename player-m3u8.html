<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HLS Player - AngulismoTV</title>
  <style>
    :root {
      --primary: #72d6ff;
      --primary-dark: #4db8e8;
      --bg: #000;
      --text: #fff;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: var(--bg); font-family: 'Inter', sans-serif; overflow: hidden; }

    #player-container {
      position: relative;
      width: 100%;
      height: 100vh;
      background: var(--bg);
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: var(--bg);
    }

    .custom-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
      padding: 20px 15px 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 9999;
      transition: opacity 0.3s;
    }

    .custom-controls.hidden { opacity: 0; pointer-events: none; }

    .control-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text);
      width: 40px;
      height: 40px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      font-size: 18px;
    }

    .control-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: scale(1.1);
    }

    .control-btn svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }

    .progress-container {
      flex: 1;
      height: 6px;
      background: rgba(255,255,255,0.2);
      border-radius: 3px;
      cursor: pointer;
      position: relative;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--primary-dark));
      border-radius: 3px;
      width: 0%;
      transition: width 0.1s linear;
    }

    .time-display {
      color: var(--text);
      font-size: 13px;
      min-width: 80px;
      text-align: center;
      font-variant-numeric: tabular-nums;
    }

    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--text);
      text-align: center;
      z-index: 10000;
    }

    .spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .play-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9998;
      cursor: pointer;
      transition: opacity 0.3s;
    }

    .play-overlay.hidden { opacity: 0; pointer-events: none; }

    .play-button {
      width: 80px;
      height: 80px;
      background: rgba(114,214,255,0.2);
      border: 3px solid var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      cursor: pointer;
    }

    .play-button:hover {
      transform: scale(1.1);
      background: rgba(114,214,255,0.4);
      box-shadow: 0 0 30px rgba(114,214,255,0.6);
    }

    .play-button svg {
      width: 40px;
      height: 40px;
      fill: white;
      margin-left: 5px;
    }

    .error-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,0,0,0.15);
      border: 2px solid rgba(255,0,0,0.4);
      border-radius: 12px;
      padding: 30px;
      max-width: min(90%, 500px);
      color: var(--text);
      z-index: 10000;
    }

    .error-message h3 { 
      color: #ff6b6b; 
      margin-bottom: 15px;
      font-size: 20px;
    }
    
    .error-message p {
      line-height: 1.6;
      margin-bottom: 10px;
    }
    
    .error-message button {
      margin-top: 15px;
      padding: 10px 20px;
      background: var(--primary);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .error-message button:hover {
      background: var(--primary-dark);
      transform: scale(1.05);
    }

    @media (max-width: 768px) {
      .control-btn { width: 36px; height: 36px; }
      .time-display { font-size: 11px; min-width: 70px; }
    }
  </style>
</head>
<body>
  <div id="player-container">
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <div id="loadingText">Cargando stream...</div>
    </div>

    <video 
      id="video" 
      playsinline 
      webkit-playsinline 
      preload="auto"
      crossorigin="anonymous"
    ></video>

    <div id="playOverlay" class="play-overlay">
      <div class="play-button">
        <svg viewBox="0 0 24 24">
          <path d="M8 5v14l11-7z"/>
        </svg>
      </div>
      <p style="margin-top:10px; opacity:0.9;">Haz clic para reproducir</p>
    </div>

    <div class="custom-controls" id="controls">
      <button class="control-btn" id="playPauseBtn" title="Reproducir/Pausar">‚ñ∂</button>
      <button class="control-btn" id="muteBtn" title="Silenciar">üîä</button>
      <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <span class="time-display" id="timeDisplay">0:00 / 0:00</span>
      <button class="control-btn" id="fullscreenBtn" title="Pantalla completa">
        <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
          <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
        </svg>
      </button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    // ==================== CONFIGURACI√ìN ====================
    const PROXY_URL = 'https://m3u8proxy.angulismotv.workers.dev';
    const USE_PROXY = true;

    // ==================== ELEMENTOS ====================
    const video = document.getElementById('video');
    const loading = document.getElementById('loading');
    const loadingText = document.getElementById('loadingText');
    const playOverlay = document.getElementById('playOverlay');
    const controls = document.getElementById('controls');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const muteBtn = document.getElementById('muteBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const timeDisplay = document.getElementById('timeDisplay');
    
    const urlParams = new URLSearchParams(window.location.search);
    const streamUrl = urlParams.get('url');

    let hls = null;
    let hideControlsTimeout = null;
    let autoplayAttempted = false;
    let retryCount = 0;
    const MAX_RETRIES = 3;

    console.log('üåê Player cargado');
    console.log('üîó Stream URL:', streamUrl);

    // ==================== FUNCIONES ====================
    function showError(message, details = '') {
      loading.style.display = 'none';
      playOverlay.classList.add('hidden');
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.innerHTML = `
        <h3>‚ö†Ô∏è Error al cargar el stream</h3>
        <p><strong>${message}</strong></p>
        ${details ? `<p style="font-size:13px; opacity:0.8; margin-top:10px;">${details}</p>` : ''}
        <button onclick="location.reload()">üîÑ Reintentar</button>
      `;
      document.getElementById('player-container').appendChild(errorDiv);
    }

    function updateLoadingText(text) {
      if (loadingText) loadingText.textContent = text;
    }

    function formatTime(seconds) {
      if (!isFinite(seconds) || isNaN(seconds)) return '0:00';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function updateProgress() {
      if (video.duration) {
        const percent = (video.currentTime / video.duration) * 100;
        progressBar.style.width = percent + '%';
        timeDisplay.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;
      }
    }

    async function attemptAutoplay() {
      if (autoplayAttempted) return;
      autoplayAttempted = true;

      console.log('üé¨ Intentando autoplay...');
      updateLoadingText('Iniciando reproducci√≥n...');
      
      try {
        await video.play();
        console.log('‚úÖ Autoplay exitoso');
        playOverlay.classList.add('hidden');
        loading.style.display = 'none';
        updatePlayButton();
      } catch (error) {
        console.warn('‚ö†Ô∏è Autoplay bloqueado, intentando muted...');
        
        try {
          video.muted = true;
          await video.play();
          console.log('‚úÖ Autoplay sin sonido OK');
          playOverlay.classList.add('hidden');
          loading.style.display = 'none';
          updateMuteButton();
          updatePlayButton();
          showUnmuteNotification();
        } catch (mutedError) {
          console.error('‚ùå Autoplay completamente bloqueado');
          loading.style.display = 'none';
          playOverlay.classList.remove('hidden');
        }
      }
    }

    function showUnmuteNotification() {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.85); color: white; padding: 12px 24px;
        border-radius: 8px; font-size: 14px; z-index: 10001;
        border: 1px solid rgba(114, 214, 255, 0.3);
      `;
      notification.textContent = 'üîá Reproduciendo sin sonido - Haz clic en üîä para activar';
      document.getElementById('player-container').appendChild(notification);
      setTimeout(() => notification.remove(), 5000);
    }

    function togglePlayPause() {
      video.paused ? video.play() : video.pause();
      updatePlayButton();
    }

    function updatePlayButton() {
      playPauseBtn.textContent = video.paused ? '‚ñ∂' : '‚è∏';
    }

    function toggleMute() {
      video.muted = !video.muted;
      updateMuteButton();
    }

    function updateMuteButton() {
      muteBtn.textContent = video.muted ? 'üîá' : 'üîä';
    }

    function toggleFullscreen() {
      const container = document.getElementById('player-container');
      
      if (!document.fullscreenElement && !document.webkitFullscreenElement) {
        const rfs = container.requestFullscreen || container.webkitRequestFullscreen || 
                    container.mozRequestFullScreen || container.msRequestFullscreen;
        if (rfs) rfs.call(container).catch(err => console.error('Fullscreen error:', err));
      } else {
        const efs = document.exitFullscreen || document.webkitExitFullscreen || 
                    document.mozCancelFullScreen || document.msExitFullscreen;
        if (efs) efs.call(document);
      }
    }

    function showControls() {
      controls.classList.remove('hidden');
      clearTimeout(hideControlsTimeout);
      if (!video.paused) {
        hideControlsTimeout = setTimeout(() => controls.classList.add('hidden'), 3000);
      }
    }

    // ==================== HLS SETUP ====================
    function setupHLS() {
      if (!streamUrl) {
        showError('No se proporcion√≥ URL del stream', 'Agrega ?url=TU_M3U8_URL a la URL');
        return;
      }

      console.log('üé¨ Configurando HLS...');
      console.log('üîó Stream original:', streamUrl);
      
      // üî• APLICAR PROXY SI ES HTTP
      let finalUrl = streamUrl;
      if (USE_PROXY && streamUrl.startsWith('http://')) {
        finalUrl = `${PROXY_URL}?url=${encodeURIComponent(streamUrl)}`;
        console.log('üîí Usando proxy para evitar Mixed Content');
        console.log('üîó Stream proxiado:', finalUrl);
      } else if (streamUrl.startsWith('https://')) {
        console.log('‚úÖ Stream ya es HTTPS, no necesita proxy');
      } else {
        console.log('üì° Carga directa');
      }

      if (Hls.isSupported()) {
        hls = new Hls({
          debug: false,
          enableWorker: true,
          lowLatencyMode: false,
          backBufferLength: 90,
          maxBufferLength: 30,
          maxMaxBufferLength: 600,
          xhrSetup: (xhr, url) => {
            xhr.withCredentials = false;
            xhr.timeout = 20000;
            console.log('üì• Petici√≥n XHR a:', url);
          }
        });

        // üî• IMPORTANTE: Cargar la URL FINAL (proxiada)
        hls.loadSource(finalUrl);
        hls.attachMedia(video);

        hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
          console.log('‚úÖ Master playlist parseado');
          console.log('üìä Calidades:', data.levels.length);
          data.levels.forEach((level, i) => {
            console.log(`   ${i}: ${level.width}x${level.height} @ ${Math.round(level.bitrate/1000)}kbps`);
          });
          attemptAutoplay();
        });

        hls.on(Hls.Events.LEVEL_LOADED, (event, data) => {
          console.log('‚úÖ Nivel cargado:', data.details.fragments.length, 'segmentos');
        });

        hls.on(Hls.Events.FRAG_LOADED, (event, data) => {
          console.log('‚úÖ Segmento', data.frag.sn, 'cargado');
        });

        hls.on(Hls.Events.ERROR, (event, data) => {
          console.error('‚ùå HLS Error:', data);
          
          if (data.fatal) {
            switch(data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                console.log('üîÑ Error de red');
                if (retryCount < MAX_RETRIES) {
                  retryCount++;
                  updateLoadingText(`Reintentando (${retryCount}/${MAX_RETRIES})...`);
                  setTimeout(() => hls.startLoad(), 2000);
                } else {
                  showError(
                    'Error de red persistente',
                    `No se pudo conectar al servidor. Detalles: ${data.details}`
                  );
                }
                break;
              
              case Hls.ErrorTypes.MEDIA_ERROR:
                console.log('üîÑ Error de media, recuperando...');
                hls.recoverMediaError();
                break;
              
              default:
                showError(
                  'Error fatal de reproducci√≥n',
                  `Tipo: ${data.type}, Detalles: ${data.details}`
                );
                break;
            }
          }
        });

      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        console.log('‚úÖ Usando HLS nativo (Safari)');
        video.src = finalUrl;
        video.addEventListener('loadedmetadata', attemptAutoplay);
        video.addEventListener('error', (e) => {
          showError(
            'Error de carga nativo',
            `C√≥digo: ${video.error?.code}, ${video.error?.message || ''}`
          );
        });
      } else {
        showError(
          'Navegador no compatible',
          'Tu navegador no soporta HLS. Usa Chrome, Firefox o Safari.'
        );
      }
    }

    // ==================== EVENT LISTENERS ====================
    function setupEventListeners() {
      playPauseBtn.addEventListener('click', togglePlayPause);
      muteBtn.addEventListener('click', toggleMute);
      fullscreenBtn.addEventListener('click', toggleFullscreen);
      
      video.addEventListener('play', updatePlayButton);
      video.addEventListener('pause', updatePlayButton);
      video.addEventListener('volumechange', updateMuteButton);
      video.addEventListener('timeupdate', updateProgress);
      
      ['fullscreenchange', 'webkitfullscreenchange'].forEach(e => 
        document.addEventListener(e, () => {
          const isFS = !!(document.fullscreenElement || document.webkitFullscreenElement);
          fullscreenBtn.style.background = isFS ? 'rgba(114, 214, 255, 0.3)' : '';
        })
      );

      progressContainer.addEventListener('click', (e) => {
        const rect = progressContainer.getBoundingClientRect();
        const percent = (e.clientX - rect.left) / rect.width;
        video.currentTime = percent * video.duration;
      });

      playOverlay.addEventListener('click', () => {
        video.muted = false;
        video.play().then(() => {
          playOverlay.classList.add('hidden');
          updatePlayButton();
          updateMuteButton();
        }).catch(err => {
          console.error('Play error:', err);
        });
      });

      video.addEventListener('dblclick', toggleFullscreen);

      document.addEventListener('keydown', (e) => {
        if (['INPUT', 'TEXTAREA'].includes(e.target.tagName)) return;
        
        switch(e.key) {
          case ' ':
            e.preventDefault();
            togglePlayPause();
            break;
          case 'f':
          case 'F':
            toggleFullscreen();
            break;
          case 'm':
          case 'M':
            toggleMute();
            break;
          case 'ArrowLeft':
            video.currentTime = Math.max(0, video.currentTime - 5);
            break;
          case 'ArrowRight':
            video.currentTime = Math.min(video.duration, video.currentTime + 5);
            break;
        }
      });

      ['mousemove', 'touchstart'].forEach(event => 
        document.addEventListener(event, showControls)
      );
      
      video.addEventListener('pause', showControls);
      video.addEventListener('play', showControls);
    }

    // ==================== INIT ====================
    function init() {
      setupEventListeners();
      setupHLS();
      showControls();
    }

    document.readyState === 'loading' ? 
      document.addEventListener('DOMContentLoaded', init) : init();
  </script>
</body>
</html>
